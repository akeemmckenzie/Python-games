{
  "file_path": "tests/test_version.py",
  "content": "\"\"\"Tests for the version endpoint.\"\"\"\n\nimport pytest\nfrom unittest.mock import patch, mock_open\nfrom fastapi.testclient import TestClient\nfrom app.main import app\nfrom app.utils import get_project_info\nimport tomllib\n\nclient = TestClient(app)\n\n\nclass TestVersionEndpoint:\n    \"\"\"Test cases for the /version endpoint.\"\"\"\n    \n    def test_version_endpoint_success(self):\n        \"\"\"Test successful version endpoint response.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"name\": \"python-games\",\n                    \"version\": \"0.1.0\"\n                }\n            }\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 200\n            assert response.json() == {\n                \"version\": \"0.1.0\",\n                \"name\": \"python-games\"\n            }\n    \n    def test_version_endpoint_json_structure(self):\n        \"\"\"Test that the response has the correct JSON structure.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"name\": \"test-app\",\n                    \"version\": \"1.2.3\"\n                }\n            }\n            \n            response = client.get(\"/version\")\n            data = response.json()\n            \n            assert \"version\" in data\n            assert \"name\" in data\n            assert isinstance(data[\"version\"], str)\n            assert isinstance(data[\"name\"], str)\n            assert len(data) == 2  # Only these two keys should be present\n    \n    def test_version_endpoint_file_not_found(self):\n        \"\"\"Test version endpoint when pyproject.toml is not found.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.side_effect = FileNotFoundError(\"pyproject.toml not found\")\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 500\n            assert \"Error retrieving version information\" in response.json()[\"detail\"]\n    \n    def test_version_endpoint_malformed_toml(self):\n        \"\"\"Test version endpoint with malformed TOML file.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.side_effect = tomllib.TOMLDecodeError(\"Invalid TOML\")\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 500\n            assert \"Error retrieving version information\" in response.json()[\"detail\"]\n    \n    def test_version_endpoint_missing_project_section(self):\n        \"\"\"Test version endpoint when project section is missing.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {}  # No project section\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 500\n            assert \"Error retrieving version information\" in response.json()[\"detail\"]\n    \n    def test_version_endpoint_missing_name(self):\n        \"\"\"Test version endpoint when project name is missing.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"version\": \"0.1.0\"\n                    # Missing name\n                }\n            }\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 500\n            assert \"Error retrieving version information\" in response.json()[\"detail\"]\n    \n    def test_version_endpoint_missing_version(self):\n        \"\"\"Test version endpoint when project version is missing.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"name\": \"python-games\"\n                    # Missing version\n                }\n            }\n            \n            response = client.get(\"/version\")\n            \n            assert response.status_code == 500\n            assert \"Error retrieving version information\" in response.json()[\"detail\"]\n\n\nclass TestGetProjectInfoUtil:\n    \"\"\"Test cases for the get_project_info utility function.\"\"\"\n    \n    def test_get_project_info_success(self):\n        \"\"\"Test successful project info extraction.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"name\": \"python-games\",\n                    \"version\": \"0.1.0\",\n                    \"description\": \"A test project\"  # Extra field should be ignored\n                }\n            }\n            \n            result = get_project_info()\n            \n            assert result == {\n                \"name\": \"python-games\",\n                \"version\": \"0.1.0\"\n            }\n    \n    def test_get_project_info_file_not_found(self):\n        \"\"\"Test get_project_info when file is not found.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.side_effect = FileNotFoundError(\"pyproject.toml not found\")\n            \n            with pytest.raises(FileNotFoundError) as exc_info:\n                get_project_info()\n            \n            assert \"Error reading project info\" in str(exc_info.value)\n    \n    def test_get_project_info_missing_name(self):\n        \"\"\"Test get_project_info when name is missing.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"version\": \"0.1.0\"\n                }\n            }\n            \n            with pytest.raises(KeyError) as exc_info:\n                get_project_info()\n            \n            assert \"Project name not found\" in str(exc_info.value)\n    \n    def test_get_project_info_missing_version(self):\n        \"\"\"Test get_project_info when version is missing.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {\n                    \"name\": \"python-games\"\n                }\n            }\n            \n            with pytest.raises(KeyError) as exc_info:\n                get_project_info()\n            \n            assert \"Project version not found\" in str(exc_info.value)\n    \n    def test_get_project_info_empty_project_section(self):\n        \"\"\"Test get_project_info with empty project section.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"project\": {}\n            }\n            \n            with pytest.raises(KeyError) as exc_info:\n                get_project_info()\n            \n            assert \"Project name not found\" in str(exc_info.value)\n    \n    def test_get_project_info_no_project_section(self):\n        \"\"\"Test get_project_info when project section is missing entirely.\"\"\"\n        with patch('app.utils.read_pyproject_toml') as mock_read:\n            mock_read.return_value = {\n                \"tool\": {\n                    \"poetry\": {}\n                }\n            }\n            \n            with pytest.raises(KeyError) as exc_info:\n                get_project_info()\n            \n            assert \"Project name not found\" in str(exc_info.value)\n"
  "explanation": "Created comprehensive tests for the version endpoint covering successful responses, JSON structure validation, and various error scenarios including missing files, malformed TOML, and missing project fields. Also included unit tests for the get_project_info utility function to ensure proper error handling and data extraction."
}